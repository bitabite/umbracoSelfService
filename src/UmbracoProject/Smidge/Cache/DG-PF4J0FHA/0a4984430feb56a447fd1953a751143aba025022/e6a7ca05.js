angular.module("umbraco.deploy").controller("UmbracoDeploy.DashboardController",["$scope","$window","$location","deployNavigation","deployConfiguration","contentResource","assetsService","deployService",function($scope,$window,$location,deployNavigation,deployConfiguration,contentResource,assetsService,deployService){function init(){assetsService.load(["lib/moment/moment.min.js"],$scope);deployService.feedbackMessageLevel&&deployService.feedbackMessageLevel().then(function(data){vm.feedbackMessageLevel=data.FeedbackMessageLevel})}function openProject(){$window.open("https://www.s1.umbraco.io/project/"+vm.config.ProjectAlias)}function openPayment(){$window.open("https://www.s1.umbraco.io/project/"+vm.config.ProjectAlias+"/paymentmethod")}function openDocumentation(){$window.open("https://docs.umbraco.com/umbraco-cloud/getting-started")}var vm=this;vm.config=deployConfiguration;vm.openProject=openProject;vm.openPayment=openPayment;vm.openDocumentation=openDocumentation;vm.feedbackMessageLevel="";vm.dropDownOpen=!1;init();vm.navigation=deployNavigation}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.ManagementDashboardController",["$scope","$location","deployQueueService","deployManagementResource","editorService","notificationsService",function($scope,$location,deployQueueService,deployManagementResource,editorService,notificationsService){function init(){deployQueueService.isLicensed().then(function(check){vm.isLicensed=check.success;vm.isLicensed?(refresh(),getConfigurationDetails(),getSchemaComparison()):vm.licenseFailureMessage=check.message;vm.isLoading=!1})}function refreshAll(){refresh(!0);getSchemaComparison()}function refresh(clearOperationMessage){timer>0&&clearTimeout(timer);clearOperationMessage&&(vm.operationMessage="");vm.loading=!0;deployManagementResource.getDashboard().then(function(result){vm.dashboard=result;vm.loading=!1;clearTimeout(timer);timer=setTimeout(function(){refresh(!0)},5e3)})}function triggerOperation(operation){vm.loading=!0;vm.showFailedOperationDetail=!1;vm.failedOperationDetail=null;vm.triggeredOperation=operation;deployManagementResource.triggerOperation(operation).then(function(result){vm.operationMessage=result;refresh();vm.loading=!1})}function downloadDeployArtifacts(){vm.loading=!0;deployManagementResource.downloadDeployArtifacts().then(function(result){return result})}function toggleFailedOperationDetail(){vm.showFailedOperationDetail?vm.showFailedOperationDetail=!1:vm.failedOperationDetail?vm.showFailedOperationDetail=!0:(vm.loading=!0,deployManagementResource.getFailedOperationDetail().then(function(result){vm.failedOperationDetail=JSON.stringify(JSON.parse(result),null,2);vm.showFailedOperationDetail=!0;vm.loading=!1}))}function copyFailedOperationDetailToClipboard(){navigator.clipboard.writeText(vm.failedOperationDetail);notificationsService.success("Failed operation details copied to clipboard.")}function getConfigurationDetails(){vm.loading=!0;deployManagementResource.getConfigurationDetails().then(function(data){vm.configurationDetails=data;vm.loading=!1})}function getSchemaComparison(){vm.loading=!0;deployManagementResource.getSchemaComparison().then(function(data){vm.schemaComparison=data.schemaComparison;initializeSchemaComparisonSortData();vm.loading=!1})}function initializeSchemaComparisonSortData(){schemaComparisonSortData=[];for(var key in vm.schemaComparison)vm.schemaComparison.hasOwnProperty(key)&&schemaComparisonSortData.push({entityType:key,sortBy:"label",sortDirection:"asc"})}function getSchemaComparisonSummary(comparisonData){var fullCount=comparisonData.length,upToDateCount=comparisonData.filter(function(value){return value.isUpToDate}).length,upToDateCountLabel;return upToDateCountLabel=fullCount===upToDateCount?"all are":upToDateCount===0?"none are":upToDateCount===1?"1 is":upToDateCount+" are",fullCount+" found, "+upToDateCountLabel+" up to date"}function scrollToId(id){$location.hash(id)}function scrollToEntityType(index){scrollToId("deploy-schema-comparison-"+index)}function scrollToAnchorLinks(){scrollToId("deploy-schema-comparison-anchor-links")}function hasOutOfDateItem(comparisonData){return comparisonData.filter(function(value){return!value.isUpToDate}).length>0}function showSchemaComparisonDetails(entityType,itemLabel,udi){var schemaComparisonDetailEditor={view:"/App_Plugins/Deploy/views/dashboards/overlays/schema-comparison-detail.html",title:"Schema Comparison",subtitle:entityType+": "+itemLabel,udi:udi,size:"medium",submit:function(){},close:function(){editorService.close()}};editorService.open(schemaComparisonDetailEditor)}function sortSchemaComparison(entityType,field){var currentSort=getSortData(entityType),sd;currentSort&&(currentSort.sortBy===field?currentSort.sortDirection=currentSort.sortDirection==="asc"?"desc":"asc":(currentSort.sortBy=field,currentSort.sortDirection="asc"),sd=currentSort.sortDirection==="asc"?1:-1,vm.schemaComparison[entityType]=vm.schemaComparison[entityType].sort(function(a,b){return(a[field]>b[field]?1:-1)*sd}))}function getSortData(entityType){for(var i=0;i<schemaComparisonSortData.length;i++)if(schemaComparisonSortData[i].entityType===entityType)return schemaComparisonSortData[i];return null}var vm=this,timer=0,schemaComparisonSortData=[];vm.isLoading=!0;vm.refreshAll=refreshAll;vm.triggerOperation=triggerOperation;vm.downloadDeployArtifacts=downloadDeployArtifacts;vm.toggleFailedOperationDetail=toggleFailedOperationDetail;vm.copyFailedOperationDetailToClipboard=copyFailedOperationDetailToClipboard;vm.getSchemaComparisonSummary=getSchemaComparisonSummary;vm.scrollToId=scrollToId;vm.scrollToEntityType=scrollToEntityType;vm.scrollToAnchorLinks=scrollToAnchorLinks;vm.hasOutOfDateItem=hasOutOfDateItem;vm.showSchemaComparisonDetails=showSchemaComparisonDetails;vm.sortSchemaComparison=sortSchemaComparison;vm.showFailedOperationDetail=!1;vm.failedOperationDetail=null;vm.triggeredOperation="";vm.dashboard=null;init()}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.OnPremDashboardController",["$scope","$window","$location","deployNavigation","deployConfiguration","deployQueueService","assetsService","deployService",function($scope,$window,$location,deployNavigation,deployConfiguration,deployQueueService,assetsService,deployService){function init(){assetsService.load(["lib/moment/moment.min.js"],$scope);deployQueueService.isLicensed().then(function(check){vm.isLicensed=check.success});deployService.feedbackMessageLevel&&deployService.feedbackMessageLevel().then(function(data){vm.feedbackMessageLevel=data.FeedbackMessageLevel})}function openProject(){$window.open("https://www.s1.umbraco.io/project/"+vm.config.ProjectAlias)}function openPayment(){$window.open("https://www.s1.umbraco.io/project/"+vm.config.ProjectAlias+"/paymentmethod")}function openDocumentation(){$window.open("https://docs.umbraco.com/umbraco-cloud/getting-started")}var vm=this;vm.config=deployConfiguration;vm.openProject=openProject;vm.openPayment=openPayment;vm.openDocumentation=openDocumentation;vm.feedbackMessageLevel="";vm.dropDownOpen=!1;init();vm.navigation=deployNavigation}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.AddToQueueDialogController",function($scope,$q,deployConfiguration,deployQueueService,navigationService,deployHelper,deployResource,treeService,$location,$routeParams,editorState,contentResource,dateHelper,userService){var vm=this,getIncludedLanguages,nowFormatted,loadingPromises,treeAlias,routePath;vm.deployConfiguration=deployConfiguration;vm.addedToQueue=!1;vm.includeDescendants=!1;vm.releaseDate=null;vm.releaseDateFormatted="";vm.currentUser=null;vm.item=$scope.currentNode||editorState.current;vm.languages=[];vm.isContent=!1;vm.contentHasVariants=!1;vm.loading=!0;vm.disableAddToQueue=!1;getIncludedLanguages=function(){return vm.languages.filter(function(language){return language.include})};nowFormatted=moment().format("YYYY-MM-DD HH:mm");vm.releaseDateConfig={enableTime:!0,dateFormat:"Y-m-d H:i",time_24hr:!0,minDate:nowFormatted,defaultDate:nowFormatted};loadingPromises=[];vm.item.nodeType=="content"&&(vm.isContent=!0,loadingPromises.push(contentResource.getById(vm.item.id).then(function(content){vm.contentHasVariants=content.variants.length>1;vm.contentHasVariants&&(vm.languages=content.variants.filter(function(variant){return!(variant.segment&&variant.language)}).map(function(variant){var allowTransfer=variant.allowedActions.includes("T");return{culture:variant.language.culture,name:variant.language.name,allowTransfer:allowTransfer,include:allowTransfer}}),vm.disableAddToQueue=getIncludedLanguages().length===0)})));loadingPromises.push(userService.getCurrentUser().then(function(user){vm.currentUser=user}));vm.item.hasChildren&&(treeAlias=treeService.getTreeAlias(vm.item),routePath=vm.item.routePath||"",loadingPromises.push(deployResource.checkForRegisteredEntityWithPermissionToTransfer(treeAlias,routePath).then(function(data){vm.withBranch=data.CanTransferDescendents})));$q.all(loadingPromises).then(function(){vm.loading=!1});vm.languagesChange=function(){vm.disableAddToQueue=!vm.contentHasVariants||getIncludedLanguages().length===0};vm.releaseDateChange=function(selectedDates,date){if(!date){console.log("not a date");return}var serverTime=dateHelper.convertToServerStringTime(moment(date),Umbraco.Sys.ServerVariables.application.serverTimeOffset);vm.releaseDate=serverTime;vm.releaseDateFormatted=dateHelper.getLocalDate(vm.releaseDate,vm.currentUser.locale,"MMM Do YYYY, HH:mm")};vm.addToQueue=function(){var promises=[],includedLanguages;vm.contentHasVariants?(includedLanguages=getIncludedLanguages(),vm.languages.length==includedLanguages.length?promises.push(deployHelper.getDeployItem(vm.item,"*",vm.includeDescendants,vm.releaseDate,$routeParams,treeService,deployResource).then(function(deployItem){deployQueueService.addToQueue(deployItem)})):includedLanguages.forEach(function(language){promises.push(deployHelper.getDeployItem(vm.item,language.culture,vm.includeDescendants,vm.releaseDate,$routeParams,treeService,deployResource).then(function(deployItem){deployQueueService.addToQueue(deployItem)}))})):promises.push(deployHelper.getDeployItem(vm.item,null,vm.includeDescendants,vm.releaseDate,$routeParams,treeService,deployResource).then(function(deployItem){deployQueueService.addToQueue(deployItem)}));$q.all(promises).then(function(){vm.addedToQueue=!0})};vm.closeDialog=function(){navigationService.hideDialog()};vm.openTransferQueue=function(){navigationService.hideDialog();$location.path("/content").search({dashboard:"deploy",mculture:$location.search().mculture})}}),function(){"use strict";function CompareDialogController($scope,deployResource,languageResource,contentResource,editorState,assetsService,deployConfiguration,navigationService){function onInit(){document.getElementById("dialog").style.width="1000px";vm.config.RestoreWorkspaces&&(vm.compareWorkspace=_.last(vm.config.RestoreWorkspaces));languageResource.getAll().then(function(languages){vm.languages=languages;languages.length>0&&(vm.selectedLanguage=languages[0]);contentResource.getById(vm.compareNode.id).then(function(content){vm.contentHasVariants=content.variants.length>1;vm.contentHasVariants||(vm.selectedLanguage=null);_.contains(content.allowedActions,"T")&&(vm.canTransfer=!0);_.contains(content.allowedActions,"Ø")&&(vm.canRestore=!0);assetsService.loadJs("lib/jsdiff/diff.js",$scope).then(function(){getContentComparison()})})})}function getContentComparison(){vm.loading=!0;vm.comparableContentFound=!1;deployResource.getContentComparison(vm.compareNode.udi,vm.selectedLanguage?vm.selectedLanguage.culture:null,vm.compareWorkspace.Url).then(function(data){data.remote?data.local.variantDisplay.state=="NotCreated"?vm.nonComparableContentMessage="The selected item does not exist in the current workspace in the "+vm.selectedLanguage.name+" language.":data.remote.variantDisplay.state=="NotCreated"?vm.nonComparableContentMessage="The selected item does not exist in the "+vm.compareWorkspace.Name+" workspace in the "+vm.selectedLanguage.name+" language.":(createDiff(data.local.variantDisplay,data.remote.variantDisplay),vm.localLastUpdatedOn=data.local.variantDisplay.updateDate,vm.remoteLastUpdatedOn=data.remote.variantDisplay.updateDate,vm.localLastUpdatedBy=data.local.lastEditedByName,vm.remoteLastUpdatedBy=data.remote.lastEditedByName,vm.localParentName=data.local.parentName,vm.remoteParentName=data.remote.parentName,vm.localNumberOfChildren=data.local.numberOfChildren,vm.remoteNumberOfChildren=data.remote.numberOfChildren,vm.localUrl=data.local.url,vm.remoteUrl=data.remote.url,vm.localReleaseDate=data.local.variantDisplay.releaseDate,vm.remoteReleaseDate=data.remote.variantDisplay.releaseDate,vm.localExpireDate=data.local.variantDisplay.expireDate,vm.remoteExpireDate=data.remote.variantDisplay.expireDate,vm.comparableContentFound=!0):vm.nonComparableContentMessage="The selected item does not exist in the "+vm.compareWorkspace.Name+" workspace.";vm.loading=!1})}function createDiff(local,remote){vm.diff={};vm.diff.properties=[];vm.diff.name=Diff.diffWords(remote.name,local.name);local.tabs.forEach(function(tab){tab.properties.forEach(function(property){for(var opi,remoteProperty,diffProperty,remoteTabIndex=-1,remoteTabPropertyIndex=-1,remoteTabs=remote.tabs,oti=0,length=remoteTabs.length;oti<length;oti++)if(opi=remoteTabs[oti].properties.findIndex(function(p){return p.alias===property.alias}),opi!==-1){remoteTabIndex=oti;remoteTabPropertyIndex=opi;break}remoteTabIndex!==-1&&remoteTabPropertyIndex!==-1&&(remoteProperty=remote.tabs[remoteTabIndex].properties[remoteTabPropertyIndex],remoteProperty=Utilities.copy(remoteProperty),property=Utilities.copy(property),property.value instanceof Object&&(property.value=stringifyObject(property.value),property.isObject=!0),remoteProperty.value instanceof Object&&(remoteProperty.value=stringifyObject(remoteProperty.value),remoteProperty.isObject=!0),property.value=property.value?property.value+"":"",remoteProperty.value=remoteProperty.value?remoteProperty.value+"":"",diffProperty={alias:property.alias,label:property.label,diff:property.isObject?Diff.diffJson(remoteProperty.value,property.value):Diff.diffWords(remoteProperty.value,property.value),isObject:property.isObject||remoteProperty.isObject},vm.diff.properties.push(diffProperty))})})}function stringifyObject(value){return JSON.stringify(value,null,1).replaceAll(",umb://",", umb://")}function changeDestination(workspace){vm.compareWorkspace=workspace;getContentComparison()}function changeLanguage(){getContentComparison()}function queueForTransfer(){goToDialog("Queue for transfer","addtoqueue")}function partialRestore(){goToDialog("Partial restore","partial-restore")}function goToDialog(name,view){navigationService.showDialog({action:{name:name,metaData:{actionView:"../App_Plugins/Deploy/views/dialogs/"+view+".html",dialogMode:!0}},node:vm.compareNode})}function close(){navigationService.hideDialog()}var vm=this;vm.loading=!0;vm.comparableContentFound=!1;vm.config=deployConfiguration;vm.compareWorkspace={};vm.restoreButtonState="init";vm.workspaceDropDownOpen=!1;vm.changeDestination=changeDestination;vm.changeLanguage=changeLanguage;vm.queueForTransfer=queueForTransfer;vm.partialRestore=partialRestore;vm.close=close;vm.canTransfer=!1;vm.canRestore=!1;vm.selectedLanguage=null;vm.languages=[];vm.contentHasVariants=!1;vm.nonComparableContentMessage="";vm.labels={};$scope.currentNode?vm.compareNode=$scope.currentNode:editorState.current&&(vm.compareNode=editorState.current);onInit()}angular.module("umbraco.deploy").controller("UmbracoDeploy.CompareDialogController",CompareDialogController)}();angular.module("umbraco.deploy").controller("UmbracoDeploy.DeployDialogController",function($scope,$q,angularHelper,deployHelper,deployService,deployConfiguration,navigationService,editorState,deploySignalrService,$routeParams,treeService,deployResource,notificationsService,dateHelper,userService){function onInit(){resetDeploy();deployService.feedbackMessageLevel&&loadingPromises.push(deployService.feedbackMessageLevel().then(function(data){vm.feedbackMessageLevel=data.FeedbackMessageLevel}));$q.all(loadingPromises).then(function(){vm.loading=!1})}function startInstantDeploy(){var node=vm.currentNode,promises,deployItems,includedLanguages;node.name=vm.currentNodeName;promises=[];deployItems=[];vm.contentHasVariants?(includedLanguages=getIncludedLanguages(),vm.languages.length==includedLanguages.length?promises.push(deployHelper.getDeployItem(node,"*",vm.includeDescendants,vm.releaseDate,$routeParams,treeService,deployResource).then(function(deployItem){deployItems.push(deployItem)})):includedLanguages.forEach(function(language){promises.push(deployHelper.getDeployItem(node,language.culture,vm.includeDescendants,vm.releaseDate,$routeParams,treeService,deployResource).then(function(deployItem){deployItems.push(deployItem)}))})):promises.push(deployHelper.getDeployItem(node,null,vm.includeDescendants,vm.releaseDate,$routeParams,treeService,deployResource).then(function(deployItem){deployItems.push(deployItem)}));$q.all(promises).then(function(){vm.deployButtonState="busy";deployService.instantDeploy(deployItems,vm.enableWorkItemLogging).then(function(){vm.deploy.deployProgress=0;vm.deploy.status="inProgress";vm.deploy.currentActivity="Please wait...";vm.deploy.timestamp=moment().format(timestampFormat);vm.deployButtonState="init";vm.enableWorkItemLogging&&(vm.deploy.showDebug=!0)},function(error){error.ClassName=error.ExceptionType;vm.deploy.status="failed";vm.deploy.error={hasError:!0,comment:error.Message,exception:error,timestamp:moment().format(timestampFormat)};vm.deployButtonState="init"})})}function resetDeploy(){vm.deploy={deployProgress:0,currentActivity:"",status:"",error:{},trace:"",showDebug:!1}}function closeDialog(){navigationService.hideDialog()}function updateLog(event,sessionUpdatedArgs){deployService.isOurSession(sessionUpdatedArgs.sessionId)&&angularHelper.safeApply($scope,function(){var progress=sessionUpdatedArgs;vm.deploy.trace+=""+progress.sessionId.substr(0,8)+" - "+workStatus[progress.status]+", "+progress.percent+"%"+(progress.comment?" - <em>"+progress.comment+"<\/em>":"")+"<br />";progress.log&&(vm.deploy.trace+="<br />"+filterLog(progress.log)+"<br /><br />")})}function filterLog(log){return log=log.replace(/(?:\&)/g,"&amp;"),log=log.replace(/(?:\<)/g,"&lt;"),log=log.replace(/(?:\>)/g,"&gt;"),log=log.replace(/(?:\r\n|\r|\n)/g,"<br />"),log=log.replace(/(?:\t)/g,"  "),log=log.replace("-- EXCEPTION ---------------------------------------------------",'<span class="umb-deploy-debug-exception">-- EXCEPTION ---------------------------------------------------'),log.replace("----------------------------------------------------------------","----------------------------------------------------------------<\/span>")}function copyDebugToClipboard(){var trace=vm.deploy.trace;trace=trace.replace(/<br\s*\/?>/mg,"\n");trace=trace.replace(/<\/?[^>]+(>|$)/g,"");navigator.clipboard.writeText(trace);notificationsService.success("Technical details copied to clipboard.")}var vm=this,timestampFormat="MMMM Do YYYY, HH:mm:ss",serverTimestampFormat="YYYY-MM-DD HH:mm:ss,SSS",getIncludedLanguages,nowFormatted,loadingPromises,i,search,workStatus;if(vm.config=deployConfiguration,vm.currentNode=editorState.current||$scope.currentNode,vm.currentNodeName=null,vm.deploy={},vm.includeDescendants=!1,vm.releaseDate=null,vm.releaseDateFormatted="",vm.currentUser=null,vm.deployButtonState="init",vm.feedbackMessageLevel="",vm.languages=[],vm.isContent=!1,vm.contentHasVariants=!1,vm.loading=!0,vm.disableTransferNow=!1,getIncludedLanguages=function(){return vm.languages.filter(function(language){return language.include})},nowFormatted=moment().format("YYYY-MM-DD HH:mm"),vm.releaseDateConfig={enableTime:!0,dateFormat:"Y-m-d H:i",time_24hr:!0,minDate:nowFormatted,defaultDate:nowFormatted},loadingPromises=[],vm.currentNode!==undefined)if(vm.isContent=vm.currentNode.nodeType=="document",vm.currentNode.variants!==undefined&&vm.currentNode.variants.length>0){for(i=vm.currentNode.variants.length;i--;)vm.currentNode.variants[i].active===!0&&(vm.currentNodeName=vm.currentNode.variants[i].name);vm.currentNode.variants.length>1&&(vm.contentHasVariants=!0,vm.contentHasVariants&&(vm.languages=vm.currentNode.variants.filter(function(variant){return!(variant.segment&&variant.language)}).map(function(variant){var allowTransfer=variant.allowedActions.includes("T");return{culture:variant.language.culture,name:variant.language.name,allowTransfer:allowTransfer,include:allowTransfer}}),vm.disableTransferNow=getIncludedLanguages().length===0))}else vm.currentNodeName=vm.currentNode.name;loadingPromises.push(userService.getCurrentUser().then(function(user){vm.currentUser=user}));vm.startInstantDeploy=startInstantDeploy;vm.resetDeploy=resetDeploy;vm.closeDialog=closeDialog;vm.copyDebugToClipboard=copyDebugToClipboard;vm.languagesChange=function(){vm.disableTransferNow=!vm.contentHasVariants||getIncludedLanguages().length===0};vm.releaseDateChange=function(selectedDates,date){if(date){var serverTime=dateHelper.convertToServerStringTime(moment(date),Umbraco.Sys.ServerVariables.application.serverTimeOffset);vm.releaseDate=serverTime;vm.releaseDateFormatted=dateHelper.getLocalDate(vm.releaseDate,vm.currentUser.locale,"MMM Do YYYY, HH:mm")}};$scope.$on("deploy:sessionUpdated",function(event,args){args.sessionId===deployService.sessionId&&angularHelper.safeApply($scope,function(){vm.deploy.deployProgress=args.percent;vm.deploy.currentActivity=args.comment;vm.deploy.status=deployHelper.getStatusValue(args.status);vm.deploy.timestamp=moment().format(timestampFormat);vm.deploy.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat);(vm.deploy.status==="failed"||vm.deploy.status==="cancelled"||vm.deploy.status==="timedOut")&&(vm.deploy.error={hasError:!0,comment:args.comment,log:args.log,exception:args.exception})})});$scope.$on("deploy:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.deploy&&(vm.deploy.timestamp=moment().format(timestampFormat),vm.deploy.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat))})});$scope.$on("deploy:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.deploy.trace+="❤<br />"})});vm.showDebug=function(){vm.deploy.showDebug=!vm.deploy.showDebug};search=window.location.search;vm.enableWorkItemLogging=search==="?ddebug";workStatus=["Unknown","New","Executing","Completed","Failed","Cancelled","TimedOut"];$scope.$on("deploy:sessionUpdated",updateLog);$scope.$on("restore:sessionUpdated",updateLog);onInit()});angular.module("umbraco.deploy").controller("UmbracoDeploy.ExportDialogController",function($scope,$q,deployService,navigationService,notificationsService,deployHelper,deployResource,$routeParams,treeService,userService,deploySignalrService,angularHelper){function updateLog(event,sessionUpdatedArgs){deployService.isOurSession(sessionUpdatedArgs.sessionId)&&angularHelper.safeApply($scope,function(){var progress=sessionUpdatedArgs;vm.export.trace+=""+progress.sessionId.substr(0,8)+" - "+workStatus[progress.status]+", "+progress.percent+"%"+(progress.comment?" - <em>"+progress.comment+"<\/em>":"")+"<br />";progress.log&&(vm.export.trace+="<br />"+filterLog(progress.log)+"<br /><br />")})}function filterLog(log){return log=log.replace(/(?:\&)/g,"&amp;"),log=log.replace(/(?:\<)/g,"&lt;"),log=log.replace(/(?:\>)/g,"&gt;"),log=log.replace(/(?:\r\n|\r|\n)/g,"<br />"),log=log.replace(/(?:\t)/g,"  "),log=log.replace("-- EXCEPTION ---------------------------------------------------",'<span class="umb-deploy-debug-exception">-- EXCEPTION ---------------------------------------------------'),log.replace("----------------------------------------------------------------","----------------------------------------------------------------<\/span>")}var isTreeExport,search,loadingPromises,treeAlias,routePath,workStatus;deploySignalrService.initialize();isTreeExport=!1;try{isTreeExport=angular.element("[ui-view]").attr("ui-view")==="tree-export"}catch(e){}var vm=this,timestampFormat="MMMM Do YYYY, HH:mm:ss",serverTimestampFormat="YYYY-MM-DD HH:mm:ss,SSS";vm.exportTriggered=!1;vm.includeDescendants=!1;vm.includeContentDependencies=!1;vm.includeSchemaDependencies=!1;vm.includeContentFileDependencies=!1;vm.includeSchemaFileDependencies=!1;vm.currentUser=null;vm.allowSchemaExport=!1;vm.export={};vm.exportButtonState="init";vm.downloadButtonState="init";search=window.location.search;vm.enableWorkItemLogging=search==="?ddebug";vm.lastSessionId=null;vm.loading=!0;loadingPromises=[];loadingPromises.push(userService.getCurrentUser().then(function(user){vm.allowSchemaExport=user.allowedSections.includes("settings");vm.currentUser=user}));isTreeExport&&(vm.item=$scope.currentNode,treeAlias=treeService.getTreeAlias(vm.item),vm.item.hasChildren&&(routePath=vm.item.routePath,loadingPromises.push(deployResource.checkForRegisteredEntityWithPermissionToExport(treeAlias,routePath).then(function(data){vm.withBranch=data.CanExportDescendents}))));deployService.feedbackMessageLevel&&loadingPromises.push(deployService.feedbackMessageLevel().then(function(data){vm.feedbackMessageLevel=data.FeedbackMessageLevel}));navigationService.allowHideDialog(!1);$q.all(loadingPromises).then(function(){vm.loading=!1});vm.startExport=function(){vm.exportButtonState="busy";vm.exportTriggered=!0;var exportPromise;exportPromise=isTreeExport?deployHelper.getDeployItem(vm.item,null,vm.includeDescendants,null,$routeParams,treeService,deployResource).then(function(deployItem){return deployService.treeExport(deployItem.id,deployItem.entityType,vm.includeDescendants,vm.includeContentDependencies,vm.includeSchemaDependencies,vm.includeContentFileDependencies,vm.includeSchemaFileDependencies,treeAlias,vm.enableWorkItemLogging)}):deployService.export(vm.includeContentDependencies,vm.includeSchemaDependencies,vm.includeContentFileDependencies,vm.includeSchemaFileDependencies,vm.enableWorkItemLogging);exportPromise.then(function(){vm.export.status="inProgress";vm.export.exportProgress=0;vm.export.currentActivity="Please wait...";vm.export.timestamp=moment().format(timestampFormat);vm.exportButtonState="init";vm.enableWorkItemLogging&&(vm.export.showDebug=!0);vm.lastSessionId=deployService.sessionId},function(error){error.ClassName=error.ExceptionType;vm.export.status="failed";vm.export.error={hasError:!0,comment:error.Message,exception:error};vm.exportButtonState="init"})};vm.showDebug=function(){vm.export.showDebug=!vm.export.showDebug};vm.copyDebugToClipboard=function(){var trace=vm.export.trace;trace=trace.replace(/<br\s*\/?>/mg,"\n");trace=trace.replace(/<\/?[^>]+(>|$)/g,"");navigator.clipboard.writeText(trace);notificationsService.success("Technical details copied to clipboard.")};$scope.$on("deploy:sessionUpdated",function(event,args){args.sessionId===deployService.sessionId&&angularHelper.safeApply($scope,function(){vm.export.exportProgress=args.percent;vm.export.currentActivity=args.comment;vm.export.status=deployHelper.getStatusValue(args.status);vm.export.timestamp=moment().format(timestampFormat);vm.export.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat);(vm.export.status==="failed"||vm.export.status==="cancelled"||vm.export.status==="timedOut")&&(vm.export.error={hasError:!0,comment:args.comment,log:args.log,exception:args.exception})})});$scope.$on("deploy:sessionUpdated",updateLog);$scope.$on("deploy:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.export&&(vm.export.timestamp=moment().format(timestampFormat),vm.export.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat))})});workStatus=["Unknown","New","Executing","Completed","Failed","Cancelled","TimedOut"];vm.downloadExport=function(){if(!vm.lastSessionId){notificationsService.error("Export","The exported archive of the selected items could not be downloaded (no session Id).");return}vm.downloadButtonState="busy";deployService.downloadExport(vm.lastSessionId).then(function(){vm.downloadButtonState="success"},function(){vm.downloadButtonState="error"})};vm.deleteExport=function(){if(!vm.lastSessionId){notificationsService.error("Export","The exported archive of the selected items could not be deleted (no session Id).");return}deployService.deleteExport(vm.lastSessionId).then(function(){notificationsService.success("Export","The exported archive of the selected items has been deleted.");vm.closeDialog()},function(){notificationsService.error("Export","The exported archive of the selected items could not be deleted.")})};vm.closeDialog=function(){navigationService.allowHideDialog(!0);navigationService.hideDialog()}});angular.module("umbraco.deploy").controller("UmbracoDeploy.ImportDialogController",function($scope,$q,deployService,navigationService,notificationsService,Upload,deployHelper,userService,deploySignalrService,angularHelper,treeService){function formatBytes(bytes){if(!+bytes)return"0 bytes";const k=1024,sizes=["bytes","kB","MB","GB"],i=Math.min(sizes.length-1,Math.floor(Math.log(bytes)/Math.log(k)));return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+" "+sizes[i]}function isSoftFail(exception){return exception!==null&&typeof exception=="object"&&exception.Type==="Umbraco.Deploy.Core.Exceptions.ImportArtifactsException"&&exception.Mismatches.some(function(x){return x.Differences.some(function(y){return y.Category==="Error"})})===!1}function updateLog(event,sessionUpdatedArgs){deployService.isOurSession(sessionUpdatedArgs.sessionId)&&angularHelper.safeApply($scope,function(){var progress=sessionUpdatedArgs;vm.import.trace+=""+progress.sessionId.substr(0,8)+" - "+workStatus[progress.status]+", "+progress.percent+"%"+(progress.comment?" - <em>"+progress.comment+"<\/em>":"")+"<br />";progress.log&&(vm.import.trace+="<br />"+filterLog(progress.log)+"<br /><br />")})}function filterLog(log){return log=log.replace(/(?:\&)/g,"&amp;"),log=log.replace(/(?:\<)/g,"&lt;"),log=log.replace(/(?:\>)/g,"&gt;"),log=log.replace(/(?:\r\n|\r|\n)/g,"<br />"),log=log.replace(/(?:\t)/g,"  "),log=log.replace("-- EXCEPTION ---------------------------------------------------",'<span class="umb-deploy-debug-exception">-- EXCEPTION ---------------------------------------------------'),log.replace("----------------------------------------------------------------","----------------------------------------------------------------<\/span>")}var vm,workStatus;deploySignalrService.initialize();vm=this;vm.state="upload";vm.warningsAsErrors=!0;vm.includeContentEntityTypes=!0;vm.includeSchemaEntityTypes=!1;vm.includeContentFileEntityTypes=!0;vm.includeSchemaFileEntityTypes=!1;vm.allowSchemaImport=!1;vm.import={};vm.maxFileSizeBytes=Umbraco.Sys.ServerVariables.umbracoSettings.maxFileSize?Umbraco.Sys.ServerVariables.umbracoSettings.maxFileSize*1024:undefined;vm.maxFileSize=formatBytes(vm.maxFileSizeBytes);vm.enableWorkItemLogging=window.location.search==="?ddebug";vm.lastSessionId=null;vm.loading=!0;vm.uploading=null;var timestampFormat="MMMM Do YYYY, HH:mm:ss",serverTimestampFormat="YYYY-MM-DD HH:mm:ss,SSS",loadingPromises=[];vm.currentUser=null;loadingPromises.push(userService.getCurrentUser().then(function(user){vm.allowSchemaImport=user.allowedSections.includes("settings");vm.allowSchemaImport&&(vm.includeSchemaEntityTypes=!0,vm.includeSchemaFileEntityTypes=!0);vm.currentUser=user}));deployService.feedbackMessageLevel&&loadingPromises.push(deployService.feedbackMessageLevel().then(function(data){vm.feedbackMessageLevel=data.FeedbackMessageLevel}));navigationService.allowHideDialog(!1);$q.all(loadingPromises).then(function(){vm.loading=!1});vm.handleFiles=function(files){files&&files.length>0&&vm.upload(files[0])};vm.upload=function(file){var upload=Upload.upload({url:Umbraco.Sys.ServerVariables.umbracoUrls.deployUiBaseUrl+"UploadForImport",fields:{},file:file});vm.serverErrorMessage=undefined;vm.uploading={upload:upload,progress:0,loaded:0,total:0};upload.then(function(resp){resp.data.Notifications&&resp.data.Notifications.length>0?vm.serverErrorMessage=resp.data.Notifications[0].message:(vm.selectedFileName=resp.data.FileName,vm.state="confirm")},function(resp){resp.status==-1||(resp.status===400?vm.serverErrorMessage=resp.message:resp.status===404?vm.serverErrorMessage="File not found":resp.status===413?vm.serverErrorMessage="File too large to upload.":resp.data&&(resp.data.InnerException?(vm.serverErrorMessage=resp.data.InnerException.ExceptionMessage,resp.data.InnerException.StackTrace&&resp.data.InnerException.StackTrace.indexOf("ValidateRequestEntityLength")>0&&(vm.serverErrorMessage="File too large to upload.")):resp.data.Message&&(vm.serverErrorMessage=evt.Message)))},function(evt){vm.uploading.progress=parseInt(100*evt.loaded/evt.total);vm.uploading.loaded=formatBytes(evt.loaded);vm.uploading.total||(vm.uploading.total=formatBytes(evt.total))});upload.finally(function(){vm.uploading=null})};vm.startImport=function(warningsAsErrors){warningsAsErrors!==undefined&&(vm.warningsAsErrors=warningsAsErrors);vm.import={};vm.importButtonState="busy";vm.state="inprogress";deployService.import(vm.selectedFileName,vm.warningsAsErrors,vm.includeContentEntityTypes,vm.includeSchemaEntityTypes,vm.includeContentFileEntityTypes,vm.includeSchemaFileEntityTypes,vm.enableWorkItemLogging).then(function(){vm.import.status="inProgress";vm.import.importProgress=0;vm.import.currentActivity="Please wait...";vm.import.timestamp=moment().format(timestampFormat);vm.importButtonState="init";vm.enableWorkItemLogging&&(vm.import.showDebug=!0);vm.lastSessionId=deployService.sessionId},function(error){vm.import.status="failed";vm.import.error={hasError:!0,comment:error.Message,exception:error,softFail:isSoftFail(error)};vm.importButtonState="init"})};vm.showDebug=function(){vm.import.showDebug=!vm.import.showDebug};vm.copyDebugToClipboard=function(){var trace=vm.import.trace;trace=trace.replace(/<br\s*\/?>/mg,"\n");trace=trace.replace(/<\/?[^>]+(>|$)/g,"");navigator.clipboard.writeText(trace);notificationsService.success("Technical details copied to clipboard.")};$scope.$on("deploy:sessionUpdated",function(event,args){args.sessionId===deployService.sessionId&&angularHelper.safeApply($scope,function(){if(vm.import.importProgress=args.percent,vm.import.currentActivity=args.comment,vm.import.status=deployHelper.getStatusValue(args.status),vm.import.timestamp=moment().format(timestampFormat),vm.import.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat),vm.import.status==="failed"||vm.import.status==="cancelled"||vm.import.status==="timedOut")vm.import.error={hasError:!0,comment:args.comment,log:args.log,exception:args.exception,softFail:isSoftFail(args.exception)};else if(vm.import.status==="completed"){var treeRoot=treeService.getTreeRoot($scope.currentNode);treeService.loadNodeChildren({node:treeRoot,section:$scope.currentNode.section})}})});$scope.$on("deploy:sessionUpdated",updateLog);$scope.$on("deploy:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.import&&(vm.import.timestamp=moment().format(timestampFormat),vm.import.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat))})});workStatus=["Unknown","New","Executing","Completed","Failed","Cancelled","TimedOut"];vm.closeDialog=function(){navigationService.allowHideDialog(!0);navigationService.hideDialog()};$scope.$on("$destroy",function(){vm.uploading?vm.uploading.upload.abort():vm.selectedFileName&&deployService.deleteImport(vm.selectedFileName)})}),function(){"use strict";function PartialRestoreDialogController($scope,deployService,deployResource,angularHelper,deployConfiguration,deployHelper,backdropService,navigationService,editorService,localizationService,treeService,editorState,deploySignalrService){function isCoreEntitySupportingRemoteTree(){return vm.treeAlias==="content"||vm.treeAlias==="media"}function resetRestoreNode(){vm.restoreNodeIsExternal=!1;vm.restoreNode=null;vm.currentNode.id!=="-1"&&(vm.restoreNode=vm.currentNode);vm.includeDescendants=!0}function onInit(){resetRestore();vm.config.RestoreWorkspaces&&(vm.restoreWorkspace=_.last(vm.config.RestoreWorkspaces));deployService.feedbackMessageLevel&&deployService.feedbackMessageLevel().then(function(data){vm.feedbackMessageLevel=data.FeedbackMessageLevel})}function freezeContextMenu(){backdropService.open({disableEventsOnClick:!0,element:"#um-deploy-partial-restore-dialog",elementPreventClick:!0});backdropService.setOpacity(0)}function thawContextMenu(){backdropService.close()}function changeDestination(workspace){vm.restoreWorkspace=workspace;resetRestoreNode()}function pickRemoteNode(workspace){navigationService.allowHideDialog(!1);var partialItemPicker={section:"deploy",treeAlias:vm.remoteTreeAlias,multiPicker:!1,title:vm.pickRemoteNodeLabel,customTreeParams:"workspace="+workspace.Url,select:function(node){vm.restoreNodeIsExternal=!0;vm.restoreNode=node;editorService.close();navigationService.allowHideDialog(!0)},close:function(){editorService.close();navigationService.allowHideDialog(!0)}};editorService.treePicker(partialItemPicker)}function startRestore(workspace){var restoreNodes=[];vm.restoreButtonState="busy";freezeContextMenu();restoreNodes=[{id:vm.restoreNode.id,udi:vm.restoreNode.udi,includeDescendants:vm.includeDescendants,treeAlias:vm.treeAlias}];deployService.partialRestore(workspace.Url,restoreNodes,vm.enableWorkItemLogging).then(function(){vm.restore.status="inProgress";vm.restore.restoreProgress=0;vm.restore.currentActivity="Please wait...";vm.restore.timestamp=moment().format(timestampFormat);vm.restoreButtonState="init";vm.enableWorkItemLogging&&(vm.restore.showDebug=!0)},function(error){error.ClassName=error.ExceptionType;vm.restore.status="failed";vm.restore.error={hasError:!0,comment:error.Message,exception:error};vm.restoreButtonState="init"})}function resetRestore(){vm.restore={restoreProgress:0,targetName:"",currentActivity:"",status:"",error:{},trace:"",showDebug:!1}}function updateLog(event,sessionUpdatedArgs){deployService.isOurSession(sessionUpdatedArgs.sessionId)&&angularHelper.safeApply($scope,function(){var progress=sessionUpdatedArgs;vm.restore.trace+=""+progress.sessionId.substr(0,8)+" - "+workStatus[progress.status]+", "+progress.percent+"%"+(progress.comment?" - <em>"+progress.comment+"<\/em>":"")+"<br />";progress.log&&(vm.restore.trace+="<br />"+filterLog(progress.log)+"<br /><br />")})}function filterLog(log){return log=log.replace(/(?:\&)/g,"&amp;"),log=log.replace(/(?:\<)/g,"&lt;"),log=log.replace(/(?:\>)/g,"&gt;"),log=log.replace(/(?:\r\n|\r|\n)/g,"<br />"),log=log.replace(/(?:\t)/g,"  "),log=log.replace("-- EXCEPTION ---------------------------------------------------",'<span class="umb-deploy-debug-exception">-- EXCEPTION ---------------------------------------------------'),log.replace("----------------------------------------------------------------","----------------------------------------------------------------<\/span>")}function closeDialog(){thawContextMenu();navigationService.hideDialog()}function canPickRemoteNode(){return vm.restoreWorkspace&&vm.restoreNode!==null&&vm.restoreNodeIsExternal===!1&&vm.entitySupportsPickRemoteNode}function copyDebugToClipboard(){var trace=vm.restore.trace;trace=trace.replace(/<br\s*\/?>/mg,"\n");trace=trace.replace(/<\/?[^>]+(>|$)/g,"");navigator.clipboard.writeText(trace);notificationsService.success("Technical details copied to clipboard.")}var routePath,nodeUdis,search,workStatus;deploySignalrService.initialize();var vm=this,timestampFormat="MMMM Do YYYY, HH:mm:ss",serverTimestampFormat="YYYY-MM-DD HH:mm:ss,SSS";vm.config=deployConfiguration;vm.restoreWorkspace={};vm.restore={};vm.restoreButtonState="init";vm.workspaceDropDownOpen=!1;vm.currentNode=$scope.currentNode||editorState.current;resetRestoreNode();vm.toggleIncludeDescendants=function(){vm.includeDescendants=!vm.includeDescendants};vm.feedbackMessageLevel="";vm.changeDestination=changeDestination;vm.startRestore=startRestore;vm.resetRestore=resetRestore;vm.closeDialog=closeDialog;vm.canPickRemoteNode=canPickRemoteNode;vm.copyDebugToClipboard=copyDebugToClipboard;vm.treeAlias=treeService.getTreeAlias(vm.currentNode);isCoreEntitySupportingRemoteTree()?(vm.entitySupportsPickRemoteNode=!0,vm.pickRemoteNodeLabel="Select "+(vm.treeAlias==="media"?"media":"content")+" to restore",vm.remoteTreeAlias=vm.treeAlias==="media"?"externalMedia":"externalContent"):vm.entitySupportsPickRemoteNode||(routePath="",deployResource.getRegisteredEntityRemoteTreeDetail(vm.treeAlias,routePath).then(function(data){data.SupportsRemoteMenu&&(vm.entitySupportsPickRemoteNode=!0,vm.pickRemoteNodeLabel="Select "+data.NodeName+" to restore",vm.remoteTreeAlias=data.TreeAlias)}));nodeUdis=[];vm.pickRemoteNode=pickRemoteNode;vm.labels={};localizationService.localizeMany(["dialogs_deployRestorePickFrom","dialogs_deployRestoreIncludingDescendants","dialogs_deployRestoreNotIncludingDescendants"]).then(function(data){vm.labels.deployRestorePickFrom=data[0];vm.labels.deployRestoreIncludingDescendants=data[1];vm.labels.deployRestoreNotIncludingDescendants=data[2]});$scope.$on("restore:sessionUpdated",function(event,args){args.sessionId===deployService.sessionId&&angularHelper.safeApply($scope,function(){vm.restore.restoreProgress=args.percent;vm.restore.currentActivity=args.comment;vm.restore.status=deployHelper.getStatusValue(args.status);vm.restore.timestamp=moment().format(timestampFormat);vm.restore.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat);vm.restore.status==="failed"||vm.restore.status==="cancelled"||vm.restore.status==="timedOut"?vm.restore.error={hasError:!0,comment:args.comment,log:args.log,exception:args.exception}:vm.restore.status==="completed"&&(navigationService.syncTree({tree:vm.treeAlias,path:vm.restoreNode.path.split(","),forceReload:!0}),vm.restoreNode.hasChildren&&treeService.loadNodeChildren({node:vm.restoreNode,section:vm.restoreNode.section}))})});$scope.$on("restore:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.restore&&(vm.restore.timestamp=moment().format(timestampFormat),vm.restore.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat))})});vm.selectNode=function(node,event){var newArray=[];node.selected?(angular.forEach(nodeUdis,function(nodeUdi){nodeUdi!==node.Udi&&newArray.push(nodeUdi)}),node.selected=!1,nodeUdis=newArray):(node.selected=!0,nodeUdis.push(node.Udi));event.stopPropagation()};$scope.$on("deploy:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.restore.trace+="❤<br />"})});vm.showDebug=function(){vm.restore.showDebug=!vm.restore.showDebug};search=window.location.search;vm.enableWorkItemLogging=search==="?ddebug";workStatus=["Unknown","New","Executing","Completed","Failed","Cancelled","TimedOut"];$scope.$on("deploy:sessionUpdated",updateLog);$scope.$on("restore:sessionUpdated",updateLog);onInit()}angular.module("umbraco.deploy").controller("UmbracoDeploy.PartialRestoreDialogController",PartialRestoreDialogController)}(),function(){"use strict";function RestoreDialogController($scope,$routeParams,deployService,angularHelper,deployConfiguration,deployHelper,backdropService,navigationService,localizationService,treeService,deploySignalrService){function onInit(){resetRestore();vm.config.RestoreWorkspaces&&(vm.restoreWorkspace=_.first(vm.config.RestoreWorkspaces));deployService.feedbackMessageLevel&&deployService.feedbackMessageLevel().then(function(data){vm.feedbackMessageLevel=data.FeedbackMessageLevel})}function freezeContextMenu(){backdropService.open({disableEventsOnClick:!0,element:"#um-deploy-restore-dialog",elementPreventClick:!0});backdropService.setOpacity(0)}function thawContextMenu(){backdropService.close()}function changeDestination(workspace){vm.restoreWorkspace=workspace}function startRestore(workspace){vm.restoreButtonState="busy";freezeContextMenu();var treeAlias="";isTreeRestore&&(treeAlias=treeService.getTreeAlias($scope.currentNode));deployService.restore(workspace.Url,treeAlias,vm.enableWorkItemLogging).then(function(){vm.restore.status="inProgress";vm.restore.restoreProgress=0;vm.restore.currentActivity="Please wait...";vm.restore.timestamp=moment().format(timestampFormat);vm.restoreButtonState="init";vm.enableWorkItemLogging&&(vm.restore.showDebug=!0)},function(error){error.ClassName=error.ExceptionType;vm.restore.status="failed";vm.restore.error={hasError:!0,comment:error.Message,exception:error};vm.restoreButtonState="init"})}function resetRestore(){vm.restore={restoreProgress:0,targetName:"",currentActivity:"",status:"",error:{},trace:"",showDebug:!1}}function updateLog(event,sessionUpdatedArgs){deployService.isOurSession(sessionUpdatedArgs.sessionId)&&angularHelper.safeApply($scope,function(){var progress=sessionUpdatedArgs;vm.restore.trace+=""+progress.sessionId.substr(0,8)+" - "+workStatus[progress.status]+", "+progress.percent+"%"+(progress.comment?" - <em>"+progress.comment+"<\/em>":"")+"<br />";progress.log&&(vm.restore.trace+="<br />"+filterLog(progress.log)+"<br /><br />")})}function filterLog(log){return log=log.replace(/(?:\&)/g,"&amp;"),log=log.replace(/(?:\<)/g,"&lt;"),log=log.replace(/(?:\>)/g,"&gt;"),log=log.replace(/(?:\r\n|\r|\n)/g,"<br />"),log=log.replace(/(?:\t)/g,"  "),log=log.replace("-- EXCEPTION ---------------------------------------------------",'<span class="umb-deploy-debug-exception">-- EXCEPTION ---------------------------------------------------'),log.replace("----------------------------------------------------------------","----------------------------------------------------------------<\/span>")}function closeDialog(){thawContextMenu();navigationService.hideDialog()}function copyDebugToClipboard(){var trace=vm.restore.trace;trace=trace.replace(/<br\s*\/?>/mg,"\n");trace=trace.replace(/<\/?[^>]+(>|$)/g,"");navigator.clipboard.writeText(trace);notificationsService.success("Technical details copied to clipboard.")}var isTreeRestore=!1,search,workStatus;try{isTreeRestore=angular.element("[ui-view]").attr("ui-view")==="tree-restore"}catch(e){}deploySignalrService.initialize();var vm=this,timestampFormat="MMMM Do YYYY, HH:mm:ss",serverTimestampFormat="YYYY-MM-DD HH:mm:ss,SSS";vm.config=deployConfiguration;vm.restoreWorkspace={};vm.restore={};vm.restoreButtonState="init";vm.closeDialog=closeDialog;vm.feedbackMessageLevel="not";vm.dropDownOpen=!1;vm.changeDestination=changeDestination;vm.startRestore=startRestore;vm.resetRestore=resetRestore;vm.feedbackMessageLevel="";vm.copyDebugToClipboard=copyDebugToClipboard;vm.labels={};localizationService.localizeMany&&localizationService.localizeMany(["dialogs_deployFullRestoreAction"]).then(function(data){vm.labels.deployFullRestoreAction=data[0]});$scope.$on("restore:sessionUpdated",function(event,args){args.sessionId===deployService.sessionId&&angularHelper.safeApply($scope,function(){if(vm.restore.restoreProgress=args.percent,vm.restore.currentActivity=args.comment,vm.restore.status=deployHelper.getStatusValue(args.status),vm.restore.timestamp=moment().format(timestampFormat),vm.restore.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat),vm.restore.status==="failed"||vm.restore.status==="cancelled"||vm.restore.status==="timedOut")vm.restore.error={hasError:!0,comment:args.comment,log:args.log,exception:args.exception};else if(vm.restore.status==="completed"){var treeRoot=treeService.getTreeRoot($scope.currentNode);treeService.loadNodeChildren({node:treeRoot,section:$scope.currentNode.section})}})});$scope.$on("restore:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.restore&&(vm.restore.timestamp=moment().format(timestampFormat),vm.restore.serverTimestamp=moment(args.serverTimestamp).format(serverTimestampFormat))})});$scope.$on("deploy:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&angularHelper.safeApply($scope,function(){vm.restore.trace+="❤<br />"})});vm.showDebug=function(){vm.restore.showDebug=!vm.restore.showDebug};search=window.location.search;vm.enableWorkItemLogging=search==="?ddebug";workStatus=["Unknown","New","Executing","Completed","Failed","Cancelled","TimedOut"];$scope.$on("deploy:sessionUpdated",updateLog);$scope.$on("restore:sessionUpdated",updateLog);onInit()}angular.module("umbraco.deploy").controller("UmbracoDeploy.RestoreDialogController",RestoreDialogController)}();angular.module("umbraco.deploy").controller("UmbracoDeploy.AddWorkspaceController",[function(){var vm=this;vm.openAddEnvironment=function(){alert("not implemented")}}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.DoneController",["deployConfiguration","deployNavigation",function(deployConfiguration,deployNavigation){var vm=this;vm.targetName=deployConfiguration.targetName;vm.targetUrl=deployConfiguration.targetUrl;vm.ok=function(){deployNavigation.navigate("queue")}}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.FlowController",[function(){var vm=this}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.ProgressController",["$scope","deployConfiguration","deployService","deployQueueService","deployNavigation",function($scope,deployConfiguration,deployService,deployQueueService,deployNavigation){var vm=this;vm.progress=0;vm.updateProgress=function(percent){vm.progress=percent};vm.deployConfiguration=deployConfiguration;$scope.$on("deploy:sessionUpdated",function(event,sessionUpdatedArgs){sessionUpdatedArgs.sessionId===deployService.sessionId&&(vm.progress=sessionUpdatedArgs.percent,sessionUpdatedArgs.status===3?(deployNavigation.navigate("done-deploy"),deployQueueService.clearQueue(),deployService.removeSessionId()):sessionUpdatedArgs.status===4?(deployService.error={comment:sessionUpdatedArgs.comment,log:sessionUpdatedArgs.log,status:sessionUpdatedArgs.status},deployNavigation.navigate("error")):sessionUpdatedArgs.status===5?(deployService.error={comment:sessionUpdatedArgs.comment,log:sessionUpdatedArgs.log,status:sessionUpdatedArgs.status},deployNavigation.navigate("error")):sessionUpdatedArgs.status===6?(deployService.error={comment:sessionUpdatedArgs.comment,log:sessionUpdatedArgs.log,status:sessionUpdatedArgs.status},deployNavigation.navigate("error")):_.defer(function(){$scope.$apply()}))});scope.$on("deploy:heartbeat",function(event,args){deployService.isOurSession(args.sessionId)&&console.log("❤")});deployService.getStatus()}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.QueueController",["deployConfiguration","deployQueueService","deploySignalrService","deployService","deployResource","deployHelper",function(deployConfiguration,deployQueueService,deploySignalrService,deployService,deployResource,deployHelper){function init(){deployResource.getEntityTypeToNameMap().then(function(data){entityTypeToNameMap=data.Map});vm.loading=!1}var vm=this,entityTypeToNameMap;vm.loading=!0;entityTypeToNameMap={};vm.deployConfiguration=deployConfiguration;vm.limitToItemAmount=2;vm.showExpandLink=!1;init();vm.items=deployQueueService.queue;vm.startDeploy=function(){deployService.deploy(vm.items)};vm.clearQueue=function(){deployQueueService.clearQueue()};vm.removeFromQueue=function(item){deployQueueService.removeFromQueue(item)};vm.refreshQueue=function(){deployQueueService.refreshQueue()};vm.restore=function(){deployService.restore()};vm.getEntityName=function(entityType){return deployHelper.getEntityName(entityType,entityTypeToNameMap)}}]);angular.module("umbraco.deploy").controller("UmbracoDeploy.WorkspaceInfoController",function(){var vm=this});angular.module("umbraco.deploy").controller("UmbracoDeploy.SchemaComparisonDetailController",["$scope","assetsService","deployManagementResource",function($scope,assetsService,deployManagementResource){function createDiff(artifactFromUmbraco,artifactFromFile){vm.artifactDiff=Diff.diffWords(stringify(artifactFromUmbraco),stringify(artifactFromFile))}function stringify(artifact){return JSON.stringify(artifact,null,4)}var vm=this;vm.title=$scope.model.title;vm.subtitle=$scope.model.subtitle;vm.close=$scope.model.close;vm.loading=!0;assetsService.loadJs("lib/jsdiff/diff.js",$scope).then(function(){deployManagementResource.getSchemaComparisonForEntity($scope.model.udi).then(function(data){data.artifactFromUmbraco?data.artifactFromFile?(createDiff(data.artifactFromUmbraco,data.artifactFromFile),vm.comparableContentFound=!0):(vm.nonComparableContentMessage="No .uda file exists for the selected item. Showing the information from Umbraco only.",vm.singleArtifactDisplay=stringify(data.artifactFromUmbraco)):(vm.nonComparableContentMessage="No data exists in Umbraco for the selected item. Showing the information from the .uda file only.",vm.singleArtifactDisplay=stringify(data.artifactFromFile));vm.loading=!1})})}])